<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        .auth-card { max-width: 400px; width: 100%; margin: auto; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); background: white; }
        .task-card { transition: transform 0.2s; border-left: 5px solid #0d6efd; }
        .task-card:hover { transform: translateY(-3px); }
        .navbar-brand { font-weight: bold; letter-spacing: 1px; }
    </style>
</head>
<body>

    <nav id="app-navbar" class="navbar navbar-expand-lg navbar-dark bg-primary hidden">
        <div class="container">
            <a class="navbar-brand" href="#">TaskMaster</a>
            <div class="d-flex align-items-center">
                <div class="dropdown">
                    <button class="btn btn-light dropdown-toggle btn-sm rounded-pill px-3" type="button" data-bs-toggle="dropdown">
                        <span id="nav-username">Account</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#profileModal" onclick="loadProfileData()">Edit Profile</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteAccount()">Delete Account</a></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container flex-grow-1 d-flex flex-column justify-content-center py-4">

        <div id="auth-screen" class="auth-card">
            <h3 class="text-center mb-4" id="auth-title">Login to TaskMaster</h3>
            
            <form onsubmit="handleAuth(event)">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" required autocomplete="off">
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" required autocomplete="new-password">
                </div>
                <div class="mb-3 d-none" id="recovery-div">
                    <label class="form-label">Recovery Key <small class="text-muted">(Save this for password resets)</small></label>
                    <input type="text" id="recovery-key" class="form-control" placeholder="e.g. pet name or pin">
                </div>
                <button type="submit" class="btn btn-primary w-100 py-2" id="auth-btn">Login</button>
                <div class="text-center mt-2">
                    <small><a href="#" data-bs-toggle="modal" data-bs-target="#resetModal" class="text-decoration-none text-danger">Forgot Password?</a></small>
                </div>
            </form>

            <div class="text-center mt-3">
                <small>
                    <a href="#" onclick="toggleAuthMode()" id="toggle-link" class="text-decoration-none">Create an account</a>
                </small>
            </div>
            
            <div class="text-center mt-4 border-top pt-3">
                <small class="text-muted">
                    <a href="#" data-bs-toggle="modal" data-bs-target="#aboutModal" class="text-secondary text-decoration-none">About the Author</a>
                </small>
            </div>
            <div id="auth-error" class="text-danger text-center mt-2 small"></div>
        </div>

        <div id="app-screen" class="container hidden h-100" style="max-width: 800px;">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" id="taskTitle" class="form-control form-control-lg" placeholder="Add a new task...">
                        <button class="btn btn-success" onclick="addTask()">Add Task</button>
                    </div>
                </div>
            </div>
            
            <h5 class="text-muted mb-3">Your Tasks</h5>
            <div id="taskList" class="vstack gap-3"></div>
        </div>

    </div>

    <div class="modal fade" id="aboutModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">About the App</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="/author.png" class="rounded-circle mb-3" alt="Author" width="100" height="100">
                    <h5>Akash Singh</h5>
                    <p class="text-muted">Technical Consultant | Full Stack Developer</p>
                    <p>Built with FastAPI, SQLite, and Bootstrap 5.</p>
                    <div class="d-flex justify-content-center gap-2">
                        <a href="https://github.com/officialakash96/" class="btn btn-outline-dark btn-sm" target="_blank">GitHub</a>
                        <a href="https://www.linkedin.com/in/akashsinghjsr/" class="btn btn-outline-primary btn-sm" target="_blank">LinkedIn</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="resetModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Reset Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label>Username</label>
                        <input type="text" id="r-username" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>Recovery Key</label>
                        <input type="text" id="r-key" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>New Password</label>
                        <input type="password" id="r-new-pass" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="resetPassword()">Reset Password</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="profileForm">
                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" id="p-fullname" class="form-control">
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Age</label>
                                <input type="number" id="p-age" class="form-control">
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Profession</label>
                                <input type="text" id="p-profession" class="form-control">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" id="p-email" class="form-control" placeholder="name@example.com">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_URL = "http://127.0.0.1:8000";
        let isLoginMode = true;

        // --- AUTH LOGIC ---
        function checkLogin() {
            const token = localStorage.getItem("access_token");
            if (token) showApp(localStorage.getItem("username"));
            else showAuth();
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            // 1. Update Text
            document.getElementById("auth-title").innerText = isLoginMode ? "Login to TaskMaster" : "Create Account";
            document.getElementById("auth-btn").innerText = isLoginMode ? "Login" : "Register";
            document.getElementById("toggle-link").innerText = isLoginMode ? "Create an account" : "Have an account? Login";
            document.getElementById("auth-error").innerText = "";

            // 2. TOGGLE VISIBILITY of Recovery Key
            const recoveryDiv = document.getElementById("recovery-div");
            if (isLoginMode) {
                recoveryDiv.classList.add("d-none"); // Hide it
                document.getElementById("recovery-key").required = false; // Not required for login
            } else {
                recoveryDiv.classList.remove("d-none"); // Show it
                document.getElementById("recovery-key").required = true; // Required for register
            }
        }

        async function handleAuth(e) {
            e.preventDefault(); // Stop form reload
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            // Only read recovery key if we are in Register mode
            const recoveryKey = isLoginMode ? null : document.getElementById('recovery-key').value;
            const errorDiv = document.getElementById('auth-error');

            try {
                if (isLoginMode) {
                    const formData = new URLSearchParams();
                    formData.append('username', username);
                    formData.append('password', password);

                    const res = await fetch(`${API_URL}/token`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: formData
                    });
                    if (!res.ok) throw new Error("Invalid credentials");
                    const data = await res.json();
                    
                    localStorage.setItem("access_token", data.access_token);
                    localStorage.setItem("username", username);
                    showApp(username);
                } else {
                    const res = await fetch(`${API_URL}/register`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            username, 
                            password,
                            recovery_key: recoveryKey //send the key 
                        })
                    });
                    if (!res.ok) {
                        const errorData = await res.json();
                        // Use the specific message from the server (e.g., "Username already registered")
                        throw new Error(errorData.detail || "Registration failed");
                    }
                    
                    alert("Account created! Please login.");
                    document.getElementById('username').value = "";
                    document.getElementById('password').value = "";
                    toggleAuthMode();
                }
            } catch (err) {
                errorDiv.innerText = err.message;
            }
        }

        // --- PROFILE LOGIC ---
        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem("access_token")}`
            };
        }

        async function loadProfileData() {
            // In a real app, you would fetch GET /users/me here to pre-fill the form
            // For now, we will just open the empty form or local placeholders
            console.log("Loading profile..."); 
        }

        async function saveProfile() {
            
            // 1. Get the data
            const profileData = {
                full_name: document.getElementById('p-fullname').value,
                email: document.getElementById('p-email').value,
                profession: document.getElementById('p-profession').value,
                age: document.getElementById('p-age').value
            };

            // 2. Send to Server
            const res = await fetch(`${API_URL}/users/me`, {
                method: 'PUT',
                headers: getHeaders(),
                body: JSON.stringify(profileData)
            });
            
            // 3. CHECK FOR ERRORS
            if (!res.ok) {
                const errorData = await res.json();
                // If it's a validation error (422), it usually comes as a list
                // We grab the first error message to show the user
                let msg = "Update failed";
                if (res.status === 422 && errorData.detail) {
                     // Pydantic validation errors often look like: "value is not a valid email address"
                     // Sometimes detail is an array, sometimes a string. Let's handle both.
                     if (Array.isArray(errorData.detail)) {
                         msg = errorData.detail[0].msg; 
                     } else {
                         msg = errorData.detail;
                     }
                }
                alert("Error: " + msg);
                return; // STOP HERE! Do not close the modal.
            }
            
            // 4. If Success, THEN close the modal
            const modalEl = document.getElementById('profileModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
            
            // 5. Update the UI text immediately without refresh
            alert("Profile Updated Successfully!");
        }

        async function deleteAccount() {
            if(!confirm("Are you sure? This will delete all your tasks permanently.")) return;
            
            await fetch(`${API_URL}/users/me`, { method: 'DELETE', headers: getHeaders() });
            logout();
        }

        async function resetPassword() {
        const data = {
            username: document.getElementById('r-username').value,
            recovery_key: document.getElementById('r-key').value,
            new_password: document.getElementById('r-new-pass').value
        };

        const res = await fetch(`${API_URL}/reset-password`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
        });

        if (!res.ok) {
            const err = await res.json();
            alert("Error: " + err.detail);
            return;
        }

        alert("Password reset successful! Please login.");
        const modalEl = document.getElementById('resetModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
    }

        function logout() {
            localStorage.clear();
            showAuth();
        }

        // --- TASK UI ---
        function showApp(username) {
            document.getElementById("auth-screen").classList.add("hidden");
            document.getElementById("app-screen").classList.remove("hidden");
            document.getElementById("app-navbar").classList.remove("hidden");
            document.getElementById("nav-username").innerText = username;
            loadTasks();
        }

        function showAuth() {
            document.getElementById("auth-screen").classList.remove("hidden");
            document.getElementById("app-screen").classList.add("hidden");
            document.getElementById("app-navbar").classList.add("hidden");
            document.getElementById('username').value = "";
            document.getElementById('password').value = "";
        }

        async function loadTasks() {
            const res = await fetch(`${API_URL}/tasks`, { headers: getHeaders() });
            if (res.status === 401) return logout();
            const tasks = await res.json();
            
            const list = document.getElementById('taskList');
            list.innerHTML = tasks.map(t => `
                <div class="card task-card p-3 shadow-sm bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fs-5">${t.title}</span>
                        <button onclick="deleteTask(${t.id})" class="btn btn-outline-danger btn-sm">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function addTask() {
            const input = document.getElementById('taskTitle');
            if (!input.value.trim()) return;
            
            await fetch(`${API_URL}/tasks`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({ title: input.value })
            });
            input.value = '';
            loadTasks();
        }

        async function deleteTask(id) {
            await fetch(`${API_URL}/tasks/${id}`, { method: 'DELETE', headers: getHeaders() });
            loadTasks();
        }

        checkLogin();
    </script>
</body>
</html>